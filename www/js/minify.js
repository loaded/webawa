function Event(name){this.name=name;this.callbacks=[]}Event.prototype.registerCallback=function(callback){this.callbacks.push(callback)};function Reactor(){this.events={}}Reactor.prototype.registerEvent=function(eventName){var event=new Event(eventName);this.events[eventName]=event};Reactor.prototype.dispatchEvent=function(eventName,eventArgs){this.events[eventName].callbacks.forEach(function(callback){callback(eventArgs)})};Reactor.prototype.addEventListener=function(eventName,callback){this.events[eventName].registerCallback(callback)};var R=new Reactor();let slideUp;let slideDown;function _cl(el){return document.createElement(el)}function _l(id){return document.getElementById(id)}let ws;let myHome;function get_appropriate_ws_url(extra_url){var pcol;var u=document.URL;if(u.substring(0,5)==="https"){pcol="wss://";u=u.substr(8)}else{pcol="ws://";if(u.substring(0,4)==="http"){u=u.substr(7)}}u=u.split("/");return pcol+u[0]+"/"+extra_url}function new_ws(urlpath,protocol){if(typeof MozWebSocket!="undefined"){return new MozWebSocket(urlpath,protocol)}return new WebSocket(urlpath,protocol)}function makeUrl(user,url){let base='files/';let ret=base+user+'/'+url;return ret}function getLink(which){let url='arrow/';switch(which){case 'down':url=url+'arrowdown.png';break;case 'up':url=url+'arrowup.png';break;case 'me':url=url+'me.png';break;case 'sms':url=url+'sms.png';break;case 'ring':url=url+'ring.png';break;case 'map':url=url+'map.png';break;case 'attachment':url=url+'attachment.png';break;case 'hash':url=url+'hash.png';break;case 'add':url=url+'add.png';break;case 'close':url=url+'close.png';break;case 'menu':url=url+'menu.png';break;case 'pin':url=url+'pin.png';break;case 'hl':url=url+'hl.png';break;case 'search':url=url+'search.png';break;case 'filter':url=url+'filter.png';break;default:break}return url}let config={width:'',height:'',lang:'en',dir:0,prefix:''};let Database=(function(){let received;let hashText;let Home=(function(){let mapmove;let hashText;function insert(database){switch(database){case 'mapmove':mapmove=received;break;case 'popup':hashText=received;break;default:break}}function get(){return mapmove}function pop(){return hashText}return{insert:insert,mapmove:get,popup:pop}})();let User=(function(){let created;let user;let logged=false;function insert(database){switch(database){case 'created':user=received;break;case 'loggin':user=received;logged=true;console.log('loggin '+logged);break;default:break}}function isLogged(){return logged}function get(){return user}return{insert:insert,user:get,logged:isLogged}})();let Profile=(function(){let hashes=[];let profile;let profileState;function insert(database){profileState=database;switch(database){case 'upload':hashes.push(received);break;case 'hash':hashes.push(received);break;case "profile":profile=received;break;default:break}}function getState(){return profileState}function get(){return hashes}function getProfile(){return profile}return{state:getState,insert:insert,hashes:get,profile:getProfile}})();let Signup=(function(){let errors;function error(){errors=received.error}function get(){return errors}return{insert:error,get:get}})();let Router=function(data){received=data;let arrstr=data.route.split("--");switch(arrstr[0]){case 'home':Home.insert(arrstr[1]);break;case 'user':User.insert(arrstr[1]);break;case 'profile':Profile.insert(arrstr[1]);break;case 'signup':Signup.insert(arrstr[1]);break;default:break}};return{Router:Router,Home:Home,User:User,Profile:Profile,Signup:Signup}})();let App=(function(){let apps=[];function run(route){let routeObject;let app=apps.find(_app=>{return _app.routes.find(rt=>{if(rt.route==route){routeObject=rt;return true}return false})});if(app){routeObject.dependencies.forEach(subroute=>{run(subroute)})}else{return}let splited=route.split('--');app.Router(splited[1])}function initializeWS(){ws=new_ws(get_appropriate_ws_url(""),"lws-minimal");ws.onopen=function(){console.log("open connection")};ws.onmessage=function got_packet(_msg){let msg=JSON.parse(_msg.data);let route=msg.route;function findRoute(){for(let t=0;t<apps.length;t+=1){for(let p=0;p<apps[t].routes.length;p+=1){if(apps[t].routes[p].route==route){return t}}}return -1}if(findRoute()!=-1){Database.Router(msg);run(route)}else{console.log(msg.route);R.dispatchEvent(msg.route)}};ws.onclose=function(){}}function addApp(app){apps.push(app)}function findIndex(url){let route=null;let ap=apps.findIndex(app=>{return app.routes.findIndex(rt=>{if(rt.url==url){route=rt.route;return true}else{return false}})>0});return route}function initializeApp(){initializeWS();let url=document.URL.pathname;run('home--init')}return{route:run,Add:addApp,start:initializeApp}})();let rplac=(function(){let profile,home,container;let direction;let profileContainer;let prefix='container--';let host;let id='container';let inited=0;let step=8;let View={configure:function(){config.width=350;config.height=window.innerHeight;config.prefix=prefix},template:function(){createContainer();setFooter()},init:function(){if(inited){return}inited=1;this.configure();this.template()}};function createContainer(){container=_cl('div');container.style.width=config.width;container.style.height=config.height;container.classList.add(prefix);container.id=id;setHeader();let subcontainer=_cl('div');subcontainer.id='homecontainer';container.append(subcontainer);document.body.append(container)}function setHeader(){let header=_cl('div');header.classList.add(prefix+'header');container.append(header)}function setFooter(){let footer=_cl('div');footer.classList.add(prefix+'footer');footer.style.height=70;let wrapper=_cl('div');let language=_cl('div');let register=_cl('div');let down=_cl('div');wrapper.classList.add(prefix+'footer-wrapper');language.classList.add(prefix+'footer-item',prefix+'footer-lang');register.classList.add(prefix+'footer-item',prefix+'footer-register');down.classList.add(prefix+'footer-item',prefix+'footer-down');let image=new Image();image.src=getLink('down');image.width=35;image.height=18;image.id='arrow';down.style.width=35;down.style.height=18;language.innerHTML='en';register.innerHTML='register/login';register.id='register';down.append(image);wrapper.append(register);wrapper.append(language);wrapper.append(down);footer.append(wrapper);if(config.dir){language.style.float='left';register.style.float='right'}else{language.style.float='right';register.style.float='left'}register.addEventListener('click',_=>{App.route('user--init')});image.addEventListener('click',_slideUp);container.append(footer)}function _slideDown(){step=14;__slideDown(1,config.height-70,-(config.height-70))}function _slideUp(){App.route('profile--init');step=14;__slideUp(1,config.height-70+40,0)}function _changeArrowToDown(){let image=_l('arrow');image.src=getLink('down');image.removeEventListener('click',_slideDown);image.addEventListener('click',_slideUp)}function _changeArrowToUp(){let image=_l('arrow');image.src=getLink('up');image.removeEventListener('click',_slideUp);image.addEventListener('click',_slideDown)}let __slideUp=function(time,remains,top){setTimeout(function(){if(remains==0){_changeArrowToUp();return};if(remains<step){step=remains}_l('profilecontainer').style.top=top-step;__slideUp(time,remains-step,top-step)},time)};let __slideDown=function(time,remains,top){setTimeout(function(){if(remains==0){_changeArrowToDown();return}if(remains<step){step=remains}_l('profilecontainer').style.top=top+step;__slideDown(time,remains-step,top+step)},time)};let Controller=(function(){let prefix='main--';let route1={route:prefix+'init',url:'',used:0,dependencies:[]};let routes=[];routes.push(route1);let Router=function(route){switch(route){case 'init':View.init();break;default:break}};return{Router:Router,routes:routes}})();App.Add(Controller);slideUp=_slideUp;slideDown=_slideDown})();let mas=(function(){let step=10;let direction;let prefix="home--";let id='home';let parent='homecontainer';let container;let mp;let inited;let View={configure:function(){},init:function(){if(inited){return}inited=1;this.template()},template:function(){setContainer();setSearchBar();setSuggestion();setMap()}};function setContainer(){let homeContainer=_cl('div');_l(parent).append(homeContainer);container=homeContainer;homeContainer.style.width=config.width;homeContainer.style.height=config.height-70;let parentContainer=_l(parent);parentContainer.style.width=config.width;parentContainer.style.height=config.height-70;homeContainer.classList.add(prefix)}function setSearchBar(){let searchContainer=_cl('div');searchContainer.classList.add(prefix+'container-search');let filter=_cl('div');let filterImage=new Image();filterImage.src=getLink('filter');filterImage.classList.add(prefix+'search-filterIcon');filter.append(filterImage);let search=_cl('div');let searchImage=new Image();searchImage.src=getLink('search');searchImage.classList.add(prefix+'search-searchIcon');search.append(searchImage);let searchInput=_cl('div');searchInput.classList.add(prefix+'search');searchInput.contentEditable="true";searchInput.addEventListener('keydown',e=>{if(e.which===13){alert("entr")}});let icons=_cl('div');icons.classList.add(prefix+'search-icons');if(config.dir){icons.append(filter);icons.append(search);searchInput.style.direction="rtl";searchContainer.append(icons);searchContainer.append(searchInput)}else{icons.append(search);icons.append(filter);searchInput.style.direction="ltr";searchContainer.append(searchInput);searchContainer.append(icons)}container.append(searchContainer)}function setSuggestion(){let suggestion=_cl('div');suggestion.classList.add(prefix+'suggestion');container.append(suggestion);_addHash(suggestion);if(config.dir){suggestion.style.direction='rtl'}else{suggestion.style.direction='ltr'}}function setMap(){let map=_cl('div');map.classList.add(prefix+'map');map.style.height=_calculateHeight();map.style.width=config.width;container.append(map);mp=L.map(map,{zoomControl:false}).setView([35.70815,51.45460],15);L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}',{attribution:'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',maxZoom:18,id:'mapbox/streets-v11',tileSize:512,zoomOffset:-1,accessToken:'pk.eyJ1IjoiMWlvMWwiLCJhIjoiY2psNThyd3luMGVsMjN4bnR3bXc4MXV2cyJ9.ks2qVsrV6d1rXu54-CyqIw'}).addTo(mp);mp.on('moveend',()=>{let data={xmin:mp.getBounds().getSouthWest().lat,ymin:mp.getBounds().getSouthWest().lng,xmax:mp.getBounds().getNorthEast().lat,ymax:mp.getBounds().getNorthEast().lng,action:"getbound"};ws.send(JSON.stringify(data))});new L.Control.Zoom({position:'bottomright'}).addTo(mp)}function mapmove(){let json=Database.Home.mapmove().data;var myIcon=L.icon({iconUrl:getLink('hl'),iconSize:[20,20]});for(let i=0;i<json.length;i+=1){latLng=L.latLng(json[i].x,json[i].y);let marker=new L.marker(latLng,{icon:myIcon}).addTo(mp).on('click',_=>{_getHashData(json[i].hash)})}}function _getHashData(hash){ws.send(JSON.stringify({hash:hash,action:'gethash'}))}function _addHash(container){let hashes=['cooking','driving','something','else'];for(let i=0;i<hashes.length;i+=1){let span=_cl('span');span.classList.add(prefix+'hash');span.innerHTML='#'+hashes[i];container.append(span)}}function _calculateHeight(){let total=config.height;return(total-(120+50+20+20))}function _hashClick(){if(document.getElementsByClassName(prefix+'description').length>0){document.getElementsByClassName(prefix+'description')[0].remove()}let hashDescription=_cl('div');hashDescription.classList.add(prefix+'description');_l('container').append(hashDescription);let info=_cl('div');info.classList.add(prefix+'description-info');let text=_cl('div');text.classList.add(prefix+'description-text');console.log(Database.Home.popup());text.innerHTML=Database.Home.popup().text;hashDescription.append(text);hashDescription.append(info);let profilename=_cl('div');profilename.classList.add(prefix+'description-infoName');profilename.innerHTML='@'+Database.Home.popup().name;let more=_cl('div');more.classList.add(prefix+'description-more');more.innerHTML="More ..";info.append(profilename);text.append(more);more.addEventListener('click',function(e){ws.send(JSON.stringify({hash:Database.Home.popup().hash,action:'hash'}))});profilename.addEventListener('click',function(e){ws.send(JSON.stringify({name:Database.Home.popup().name,action:'profile'}))});hashDescription.addEventListener('click',()=>{__slideUp(hashDescription,10,114,0)});__slideDown(hashDescription,10,114,-114)}let __slideUp=function(container,time,remains,top){setTimeout(function(){if(remains==0){container.remove();step=10;return};console.log(remains,top);if(remains<step){step=remains}container.style.top=top-step;__slideUp(container,time,remains-step,top-step)},time)};let __slideDown=function(container,time,remains,top){setTimeout(function(){if(remains==0){step=10;return};if(remains<step){step=remains}container.style.top=top+step;__slideDown(container,time,remains-step,top+step)},time)};let Controller=(function(){let init=prefix+'init';let map=prefix+'mapmove';let route1={route:init,url:'',used:0,dependencies:['main--init']};let route2={route:map,url:'adfkj',used:0,dependencies:['main--init']};let route3={route:prefix+'popup',url:'',used:0,dependencies:[]};let routes=[];routes.push(route1);routes.push(route2);routes.push(route3);let Router=function(route){switch(route){case 'init':View.init();break;case 'mapmove':mapmove();break;case 'popup':_hashClick();break;default:break}};return{Router:Router,routes:routes}})();App.Add(Controller)})();(function(){let inited=0;let container;let header;let editing=0;let step=10;let urls;let parent;let prefix='profile--';let footerCreated=0;let files;let mapCreated=0;let location;let state;let hashContainer;let currentHash=0;let hashItems=['select','sort','delete','something'];let fileItems=['insert','select','sort','delete','fullscreen'];let View={configure:function(){},init:function(){if(inited){return}inited=1;this.template()},template:function(){setContainer();setHeader();setProfile();setControlBar();setHashContainer();},createHash:function(){slideHashControls();emptyHashContainer();addInputHash()}};function setHashContainer(){hashContainer=_cl('div');hashContainer.classList.add(prefix+'hash-container');hashContainer.id='hash-container';hashContainer.style.height=_calculateHeight();container.append(hashContainer)}function createProfilePage(){profileContainer=_cl('div');profileContainer.id='profilecontainer';parent=profileContainer;_l('container').append(profileContainer)}function setContainer(){createProfilePage();container=_cl('div');container.classList.add(prefix);container.style.width=config.width;container.style.height=config.height-70;parent.style.width=config.width;parent.style.height=config.height-70;parent.append(container)}function setHeader(){header=_cl('div');header.classList.add(prefix+'header');header.style.height=60;container.append(header)}function setProfile(){let profile=_cl('div');profile.classList.add(prefix+'identity');let image=new Image();image.src=getLink('me');image.classList.add(prefix+'profile-image');let name=_cl('div');name.classList.add(prefix+'name');name.innerHTML='Abohamze Somali';let sms=new Image();sms.classList.add(prefix+'sms');sms.src=getLink('sms');sms.addEventListener('click',()=>{});let contact=_cl('div');contact.classList.add(prefix+'contact');contact.append(sms);if(config.dir){contact.style.float='left';profile.style.float='right';name.style.direction="rtl";profile.append(name);profile.append(image);name.classList.add(prefix+'name-right')}else{profile.style.float='left';contact.style.float='right';name.style.direction="ltr";profile.append(image);profile.append(name)}header.append(profile);header.append(contact)}function setControlBar(){let bar=_cl('div');bar.classList.add(prefix+'controlbar');bar.id='controllbar';bar.style.height=32;let controls=['map','attachment','add','hash'];let icons=_cl('div');for(let i=0;i<controls.length;i+=1){let image=new Image();image.src=getLink(controls[i]);image.classList.add(prefix+'icons');image.addEventListener('click',function(){_buttons(controls[i])});icons.append(image)}if(!config.dir){bar.style.justifyContent='flex-end'}else{bar.style.justifyContent='flex-start'}icons.classList.add(prefix+'hash-controls');bar.append(icons);container.append(bar)}function setHashes(){if(clearContainer(prefix+"hashes")){let wrapper=_l(prefix+'hashes');wrapper.innerHTML='';hashContainer.append(_addHashes(wrapper));return}let image=new Image();image.src=getLink('menu');image.classList.add(prefix+'hash-menu');hashContainer.append(image);image.addEventListener('click',_=>{_bringMenu(hashContainer,image,hashItems)});let wrapper=_cl('div');wrapper.id=prefix+'hashes';hashContainer.append(_addHashes(wrapper))}function _bringMenu(container,_menu,items){let menu=_cl('div');menu.classList.add(prefix+'hash-menuContainer');let header=_cl('div');header.classList.add(prefix+'hash-menuHeader');menu.append(header);container.append(menu);menuItems(menu,_menu,items);_menu.style.display='none'}function menuItems(menu,_menu,items){for(let i=0;i<items.length;i+=1){let div=_cl('div');div.classList.add(prefix+'hash-menuItems');div.innerHTML=items[i];div.addEventListener('click',function(e){_handler(items[i])});menu.append(div);div.addEventListener('mouseenter',(e)=>{e.target.style.color='lightgrey'});div.addEventListener('mouseleave',(e)=>{e.target.style.color='white'})}let close=new Image();close.src=getLink('close');close.classList.add(prefix+'hash-menuImage');let div=_cl('div');div.classList.add(prefix+'hash-menuClose');close.addEventListener('click',_=>{menu.remove();_menu.style.display='block'});div.append(close);menu.append(div)}function _handler(item){switch(item){case 'insert':_insertFiles();break;default:break}}function _addHashes(wrapper){let hashes=Database.Profile.profile().hashes;for(let i=0;i<hashes.length;i+=1){let span=_cl('div');span.classList.add(prefix+'hash-hash');span.innerHTML='#'+hashes[i].hash;console.log(hashes[i]);if(config.dir){span.style.float='right'}else{span.style.float='left'}wrapper.append(span)}return wrapper}function _calculateHeight(){let total=config.height;return(total-(120+50+20+20))}function slideHashControls(){let hashControlsContainer=_cl('div');hashControlsContainer.classList.add(prefix+'hash-controlsAdd');let map=new Image();image.src=getLink('deadmap');map.classList.add(prefix+'map-dead');let attachment=_cl('div');attachment.classList.add(prefix+'hash-attachment')}function emptyHashContainers(){let hashContainer=_l('hash-container');hashContainer.classList.add(prefix+'hash-adding');hashContainer.innerHTML=''}function addInputHash(){}function _buttons(action){switch(action){case 'add':_addHashHandler();break;case 'attachment':_addAttachments();break;case 'hash':_hashAction();break;case 'map':_mapAction();default:break}}function clearContainer(remain){console.log(remain);let elements=[prefix+'text','file-container',prefix+'textarea',prefix+'hashes','select-map'];let ret=0;Array.from(hashContainer.children).forEach(el=>{if(el.id==remain){if(remain==prefix+'file-container'){el.style.display='flex'}else{el.style.display='block'}ret=1}else{el.style.display='none'}});return ret}function _mapAction(){if(clearContainer('select-map')){return}let map=_cl('div');map.classList.add(prefix+'map');map.style.height=_calculateHeight();map.style.width=config.width;map.id='select-map';let container=_l('hash-container');container.append(map);let mp=L.map(map,{zoomControl:false}).setView([35.70815,51.45460],15);L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}',{attribution:'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',maxZoom:18,id:'mapbox/streets-v11',tileSize:512,zoomOffset:-1,accessToken:'pk.eyJ1IjoiMWlvMWwiLCJhIjoiY2psNThyd3luMGVsMjN4bnR3bXc4MXV2cyJ9.ks2qVsrV6d1rXu54-CyqIw'}).addTo(mp);new L.Control.Zoom({position:'bottomright'}).addTo(mp);let newMarker;var myIcon=L.icon({iconUrl:getLink('pin'),iconSize:[20,35]});mp.on('click',(e)=>{if(newMarker){mp.removeLayer(newMarker)}location=e.latlng;newMarker=new L.marker(e.latlng,{icon:myIcon}).addTo(mp)})}function _gotoWriteMode(){clearContainer('profile--textarea')}function _hashAction(){console.log(state);switch(Database.Profile.state()){case 'upload':clearContainer(prefix+'textarea');break;case 'hash':clearContainer(prefix+'text');break;case 'profile':clearContainer(prefix+'hashes');break;default:break}}function _addAttachments(){if(!clearContainer('file-container')){let fileContainer=_cl('div');fileContainer.classList.add(prefix+'files');fileContainer.id='file-container';fileContainer.style.height=_calculateHeight();_l('hash-container').append(fileContainer);_addAttachmentMenu(fileContainer)}else{Array.from(_l('file-container').children).forEach(el=>{el.remove()});_addAttachmentMenu(_l('file-container'))}showFiles()}function _addAttachmentMenu(fileContainer){let input=_cl('input');input.type='file';input.id='input';input.addEventListener('change',_getInputFiles);input.style.display='none';input.multiple="multiple";let image=new Image();image.src=getLink('menu');image.classList.add(prefix+'hash-menu');fileContainer.append(image);fileContainer.append(input);image.draggable=true;image.addEventListener('click',_=>{_bringMenu(fileContainer,image,fileItems)})}function inputMenu(container){let image=new Image();image.src=getLink('menu');image.classList.add(prefix+'hash-menu');container.append(image);image.addEventListener('click',_=>{_bringMenu(container,image)})}function _prepareContainer(action){switch(action){case 'select-location':break;default:break}}function _selectFileEventHandler(item){switch(item){case 'insert':_insertFiles();break;case 'delete':_deleteFiles();break;case 'select':_selectFiles();break;case 'sort':_sortFiles();break;default:break}}function _insertFiles(){_l('input').click()}function _deleteFiles(){}function _selectFiles(){}function _sortFiles(){}function _getInputFiles(e){const partitionSize=100;files=e.target.files;let fileContainer=_l('file-container');for(let i=0;i<files.length;i+=1){let wrapper=_cl('div');wrapper.classList.add(prefix+'filecontainer-wrapper');let image=new Image();image.style.display='none';let canvas=_cl('canvas');fileContainer.append(wrapper);let reader=new FileReader();reader.onload=function(e){image.src=e.target.result;image.onload=function(){let width=this.width;let height=this.height;if(width>height){canvas.width=partitionSize;canvas.height=height/width*partitionSize;canvas.style.marginTop=(partitionSize-canvas.height)/2}else{canvas.height=partitionSize;canvas.width=width/height*partitionSize;canvas.style.marginLeft=(partitionSize-canvas.width)/2}canvas.classList.add(prefix+'selected');canvas.selected=1;canvas.addEventListener('click',()=>{if(canvas.selected){canvas.classList.remove(prefix+'selected');canvas.classList.add(prefix+'unselected');canvas.selected=0}else{canvas.classList.remove(prefix+'unselected');canvas.classList.add(prefix+'selected');canvas.selected=1}});wrapper.append(canvas);let cantx=canvas.getContext('2d');cantx.drawImage(this,0,0,canvas.width,canvas.height)}};reader.readAsDataURL(input.files[i])}}function showFiles(){if(_l(prefix+'input-hash')||urls===undefined){return}const partitionSize=100;let fileContainer=_l('file-container');fileContainer.style.display='flex';console.log("oceaner is "+oceaner);console.log("state is "+state);for(let i=0;i<urls.length;i+=1){let wrapper=_cl('div');wrapper.classList.add(prefix+'filecontainer-wrapper');let image=new Image();image.style.display='none';let canvas=_cl('canvas');fileContainer.append(wrapper);let pth=makeUrl(oceaner,urls[i].url);console.log(pth);image.src=pth;image.onload=function(){console.log("loaded");let width=this.width;let height=this.height;if(width>height){canvas.width=partitionSize;canvas.height=height/width*partitionSize;canvas.style.marginTop=(partitionSize-canvas.height)/2}else{canvas.height=partitionSize;canvas.width=width/height*partitionSize;canvas.style.marginLeft=(partitionSize-canvas.width)/2}canvas.classList.add(prefix+'selected');canvas.selected=1;canvas.addEventListener('click',()=>{if(canvas.selected){canvas.classList.remove(prefix+'selected');canvas.classList.add(prefix+'unselected');canvas.selected=0}else{canvas.classList.remove(prefix+'unselected');canvas.classList.add(prefix+'selected');canvas.selected=1}});wrapper.append(canvas);console.log(wrapper);let cantx=canvas.getContext('2d');cantx.drawImage(this,0,0,canvas.width,canvas.height);console.log('finall')}}}function _clearHashUpload(){files=null;_l(prefix+'hash-input').remove();clearContainer(prefix+'text');setTextContainer();_titleHash()}function showHash(){setTextContainer();_titleHash()}function _titleHash(){if(_l(prefix+'hash-title')){_l(prefix+'hash-title').remove();}let hashTitle=_cl('div');hashTitle.id=prefix+'hash-title';hashTitle.classList.add(prefix+'hash-title');let h=_cl('span');h.classList.add(prefix+'hash-show');h.id=prefix+'hash-show';h.innerHTML='#'+Database.Profile.hashes()[currentHash].title;let controls=_cl('div');controls.classList.add(prefix+'hash-submenu');if(Database.User.logged()){if(Database.Profile.hashes()[currentHash].name==Database.User.user().user){let edit=_cl('span');edit.classList.add(prefix+'hash-edit');edit.innerHTML='edit';let del=_cl('span');del.classList.add(prefix+'hash-delete');del.innerHTML='delete';edit.addEventListener('click',_=>{titleEventHandler('edit')});del.addEventListener('click',_=>{titleEventHandler('delete')});controls.append(edit);controls.append(del)}else{let user=_cl('span');user.innerHTML='@'+Database.Profile.hashes()[currentHash].name;user.classList.add(prefix+'hash-edit');user.style.color='blue';let save=_cl('span');save.innerHTML='save';save.classList.add(prefix+'hash-delete');user.addEventListener('click',_=>{titleEventHandler('user')});save.addEventListener('click',_=>{titleEventHandler('save')});R.registerEvent('hash-save');R.addEventListener('hash-save',_=>{save.innerHTML='saved'});controls.append(user);controls.append(save)}}else{let user=_cl('span');user.innerHTML='@'+Database.Profile.hashes()[currentHash].name;user.classList.add(prefix+'hash-edit');user.style.color='blue';user.addEventListener('click',_=>{titleEventHandler('user')});controls.append(user)}let date=_cl('div');date.innerHTML=Date().substring(0,10);date.classList.add(prefix+'hash-edit');controls.append(date);hashTitle.append(h);hashTitle.append(controls);_l('profilecontainer').append(hashTitle);__slideDown(hashTitle,10,60,-60).then(res=>console.log(res))}function titleEventHandler(){let args=arguments.length;let json;switch(arguments[0]){case 'edit':break;case 'delete':json={'action':'delete-hash',hash:Database.Profile.hashes()[currentHash].hash};ws.send(JSON.stringify(json));break;case 'user':json={'action':'profile',name:arguments[1]};ws.send(JSON.stringify(json));break;case 'save':json={'action':'save',hash:Database.Profile.hashes()[currentHash].hash};ws.send(JSON.stringify(json));break;default:break}}function _addHashHandler(){state='upload';let hashInput=_cl('div');hashInput.id=prefix+'hash-input';hashInput.classList.add(prefix+'hash-input');let input=_cl('input');input.classList.add(prefix+'input-text');input.placeholder='#';input.id="publish";let send=_cl('span');send.innerHTML='publish';send.classList.add(prefix+'send');hashInput.append(input);hashInput.append(send);send.addEventListener('click',_upload);let name,hash;name=_cl('div');hash=_cl('span');name.innerHTML='name';hash.innerHTML='hash';name.classList.add(prefix+'hash-name');hash.classList.add(prefix+'hash-sha1');let controls=_cl('div');controls.classList.add(prefix+'hash-controls');controls.append(name);controls.append(hash);if(!config.dir){send.style.float='right';send.style.direction="ltr";input.style.float='left';input.style.direction='ltr'}else{send.style.float='left';send.style.direction="rtl";input.style.float='right';input.style.direction='rtl'}_l('profilecontainer').append(hashInput);hashInput.append(controls);__slideDown(hashInput,10,60,-60).then(res=>{setEditor()})}let __slideDown=function(container,time,remains,top){function decide(num){if(num!=0){__slideDown(container,time,remains-step,top+step)}else{return new Promise((resolve,reject)=>{step=10;resolve()})}}return someAsyncWork(container,time,remains,top).then(decide)};function someAsyncWork(container,time,remains,top){return new Promise((resolve,reject)=>{setTimeout(function(){if(remains<step){step=remains}container.style.top=top+step;resolve(remains)},time)})}function setTextContainer(){if(clearContainer(prefix+'text')){let textContainer=_l(prefix+'text');textContainer.innerHTML=Database.Profile.hashes()[currentHash].text;return};let hashContainer=_l('hash-container');let textContainer=_cl('div');textContainer.classList.add(prefix+'textarea');textContainer.id=prefix+'text';textContainer.style.height=_calculateHeight();hashContainer.append(textContainer);textContainer.innerHTML=Database.Profile.hashes()[currentHash].text;if(config.dir){textContainer.style.direction='rtl'}else{textContainer.style.direction='ltr'}}function setEditor(){if(clearContainer(prefix+'textarea')){return}let hashContainer=_l('hash-container');let textarea=_cl('textarea');textarea.classList.add(prefix+'textarea');textarea.id=prefix+'textarea';textarea.style.height=_calculateHeight();textarea.placeholder='type here';hashContainer.append(textarea);if(config.dir){textarea.style.direction='rtl'}else{textarea.style.direction='ltr'}}function _closeAddHash(){}function _upload(){let index=0;let offset=0;let chunkSize=512;let offSize;let numberOfFiles;let title=_l('publish').value;let x=location.lat;let y=location.lng;if(files){numberOfFiles=files.length}let text=_l(prefix+'textarea').value;let startUpload={nfile:numberOfFiles,x:x,y:y,title:title,text:text,action:'insert'};console.log(startUpload);let fileReader=new FileReader();let readSlice=function(i){if(!files[i]){return}if((files[i].length-1)<i){return}chunkSize=files[i].size;if(offset+chunkSize>files[i].size){offSize=files[i].size-offset}else{offSize=offset+chunkSize}let slice=files[i].slice(offset,offSize);fileReader.readAsArrayBuffer(slice)};fileReader.addEventListener('load',function(e){let arrayBuffer=new Uint8Array(e.target.result);let buff=Array.from(arrayBuffer);let jObject={data:buff,total:files[index].size,len:e.target.result.byteLength,filename:files[index].name,action:"upload"};ws.send(JSON.stringify(jObject));if(offSize<=offset+chunkSize){index+=1;offset=0}else{offset+=e.target.result.byteLength}readSlice(index)});ws.send(JSON.stringify(startUpload));readSlice(0)}let Controller=(function(){let routes=[];let route1={route:prefix+'init',url:'',dependencies:['main--init','home--init'],used:0};let route2={route:prefix+'upload',url:'',dependencies:['main--init','home--init'],used:0};let route3={route:prefix+'hash',url:'',dependencies:['profile--init'],used:0};let route4={route:prefix+'profile',url:'',dependencies:['profile--init'],used:0};routes.push(route3);routes.push(route1);routes.push(route2);routes.push(route4);let Router=function(route){switch(route){case 'init':View.init();break;case 'upload':currentHash=Database.Profile.hashes().length-1;urls=Database.Profile.hashes()[currentHash].urls;_clearHashUpload();break;case 'hash':currentHash=Database.Profile.hashes().length-1;urls=Database.Profile.hashes()[currentHash].urls;oceaner=Database.Profile.hashes()[currentHash].name;slideUp();showHash();break;case 'profile':if(_l(prefix+'hash-title')){_l(prefix+'hash-title').remove()}urls=Database.Profile.profile().urls;oceaner=Database.Profile.profile().name;slideUp();setHashes();break;default:break}};return{Router:Router,routes:routes}})();App.Add(Controller)})();(function(){let prefix='user--';let container,body;let step=8;let parent;let View={configure:function(){},template:function(){createContainer();createHeader();createBody();createLoginBox();},init:function(){parent=_l('container');this.configure();this.template()}};function createBackground(){let container=document.createElement('div');container.classList.add(prefix+'background');container.id=prefix+'background';container.style.width=config.width;container.style.height=window.innerHeight;document.getElementById('container').append(container)}function createContainer(){createBackground();container=_cl('div');container.classList.add(prefix+'container');parent.append(container)}function createHeader(){let header=_cl('div');header.classList.add(prefix+'header');let login=_cl('div');let slash=_cl('div');let register=_cl('div');login.innerHTML='login';slash.innerHTML=' / ';register.innerHTML='register';login.classList.add(prefix+'header-login');register.classList.add(prefix+'header-register');slash.classList.add(prefix+'header-slash');let wrapper=_cl('div');wrapper.classList.add(prefix+'header-wrapper');login.addEventListener('click',_loginHandler);register.addEventListener('click',_registerHandler);wrapper.append(login);wrapper.append(slash);wrapper.append(register);header.append(wrapper);container.append(header);if(config.dir){wrapper.style.direction="rtl"}}function createBody(){body=_cl('div');body.classList.add(prefix+'body');container.append(body)}function _loginHandler(){let style=window.getComputedStyle(_l(prefix+'login'));let width=style.getPropertyValue('width');let register=_l(prefix+'register');__slideRight(register,1,0,parseInt(width))}function _registerHandler(){let style=window.getComputedStyle(_l(prefix+'login'));let width=style.getPropertyValue('width');if(_l(prefix+'register')){_slideLeft(_l(prefix+'register'),1,parseInt(width),0)}else{let reg=createRegisterBox();_slideLeft(reg,1,parseInt(width),0)}}function _registerUser(){}function createRegisterBox(){let loginBox=_cl('div');loginBox.classList.add(prefix+'login');let usernameBox=_cl('div');let passwordBox=_cl('div');let userLabel=_cl('div');let passwordLabel=_cl('div');userLabel.innerHTML='username';passwordLabel.innerHTML='email';userLabel.classList.add(prefix+'label-user');passwordLabel.classList.add(prefix+'label-pass');let user=_cl('input');let pass=_cl('input');user.classList.add(prefix+'login-user');pass.classList.add(prefix+'login-pass');usernameBox.append(user);usernameBox.append(userLabel);passwordBox.append(pass);passwordBox.append(passwordLabel);usernameBox.classList.add(prefix+'login-username');passwordBox.classList.add(prefix+'login-password');let forgetPass=_cl('div');forgetPass.classList.add(prefix+'forget');let content=_term('I agree with this');content.classList.add(prefix+'term');forgetPass.append(content);let actionBox=_cl('div');actionBox.classList.add(prefix+'action');actionBox.innerHTML='send';actionBox.addEventListener('click',_=>{ws.send(JSON.stringify({'user':user.value,'email':pass.value,'action':'register'}))});loginBox.append(usernameBox);loginBox.append(passwordBox);loginBox.append(forgetPass);loginBox.append(actionBox);let registerWrapper=_cl('div');registerWrapper.id=prefix+'register';let style=window.getComputedStyle(_l(prefix+'login'));let width=style.getPropertyValue('width');registerWrapper.style.left=width;registerWrapper.append(loginBox);body.append(registerWrapper);user.addEventListener('focus',_=>{let width=_howMuch(userLabel);__slideLeft(userLabel,10,width,width)});pass.addEventListener('focus',_=>{let width=_howMuch(passwordLabel);__slideLeft(passwordLabel,10,width,width)});if(config.dir){user.style.direction="rtl";pass.style.direction="rtl";content.style.direction="rtl";actionBox.style.direction="rtl";userLabel.style.direction="rtl";passwordLabel.style.direction="rtl";userLabel.style.right=0;passwordLabel.style.right=0}return registerWrapper}function createLoginBox(){let loginBox=_cl('div');loginBox.classList.add(prefix+'login');let usernameBox=_cl('div');let passwordBox=_cl('div');let userLabel=_cl('div');let passwordLabel=_cl('div');userLabel.innerHTML='username';passwordLabel.innerHTML='password';userLabel.classList.add(prefix+'label-user');passwordLabel.classList.add(prefix+'label-pass');let user=_cl('input');let pass=_cl('input');user.classList.add(prefix+'login-user');pass.classList.add(prefix+'login-pass');usernameBox.append(user);usernameBox.append(userLabel);passwordBox.append(pass);passwordBox.append(passwordLabel);usernameBox.classList.add(prefix+'login-username');passwordBox.classList.add(prefix+'login-password');let forgetPass=_cl('div');forgetPass.classList.add(prefix+'forget');forgetPass.innerHTML='forget password ? reset';forgetPass.addEventListener('mouseover',_=>{forgetPass.style.backgroundColor='lightblue';forgetPass.style.color='black'});forgetPass.addEventListener('mouseleave',_=>{forgetPass.style.backgroundColor='white';forgetPass.style.color='lightblue'});let actionBox=_cl('div');actionBox.classList.add(prefix+'action');actionBox.innerHTML='send';actionBox.addEventListener('click',_=>{ws.send(JSON.stringify({'user':user.value,'pass':pass.value,'action':'login'}))});loginBox.append(usernameBox);loginBox.append(passwordBox);loginBox.append(forgetPass);loginBox.append(actionBox);let loginWrapper=_cl('div');loginWrapper.id=prefix+'login';loginWrapper.append(loginBox);body.append(loginWrapper);user.addEventListener('focus',_=>{let width=_howMuch(userLabel);__slideLeft(userLabel,10,width,width)});pass.addEventListener('focus',_=>{let width=_howMuch(passwordLabel);__slideLeft(passwordLabel,10,width,width)});if(config.dir){user.style.direction="rtl";pass.style.direction="rtl";forgetPass.style.direction="rtl";actionBox.style.direction="rtl";userLabel.style.direction="rtl";passwordLabel.style.direction="rtl";userLabel.style.right=0;passwordLabel.style.right=0}}let __slideRight=function(container,time,remains,left){setTimeout(function(){if(remains==left){container.style.left=left;step=8;return}if((left-remains)<step){step=(left-remains)}container.style.left=remains;__slideRight(container,time,remains+step,left)},time)};let _slideLeft=function(container,time,remains,left){setTimeout(function(){if(remains==0){container.style.left=0;step=8;return}if(remains<step){step=remains}container.style.left=remains;_slideLeft(container,time,remains-step,left)},time)};let __slideLeft=function(container,time,remains,left){setTimeout(function(){if(remains==0){step=8;return}if(remains<step){step=remains}if(config.dir){container.style.right=remains-left}else{container.style.left=remains-left}__slideLeft(container,time,remains-step,left)},time)};function _term(title){let term=_cl('div');let span=_cl('span');span.innerHTML=title;span.style.color='black';let canvas=_checkbox(20,20);canvas.style.cursor='pointer';term.appendChild(canvas);term.appendChild(span);if(config.dir){span.style.marginRight=5}else{span.style.marginLeft=5}canvas.addEventListener('click',_=>{_checked(term)});return term}function _checked(term){let canvas=_cl('canvas');canvas.width=20;canvas.height=20;let context=canvas.getContext('2d');let radius=1;canvas.style.position='absolute';canvas.style.zIndex=101;term.appendChild(canvas);let id=window.setInterval(function(){if(radius>4){clearInterval(id);return}radius+=1;context.beginPath();context.arc(10,10,radius,0,2*Math.PI);context.closePath();context.fillStyle='black';context.fill()},50);canvas.addEventListener('click',function(){_uncheck(canvas)})}function _uncheck(canvas){let radius=4;let context=canvas.getContext('2d');let x=canvas.width/2;let y=canvas.height/2;let id=window.setInterval(function(){if(radius<2){clearInterval(id);canvas.remove()}context.beginPath();context.arc(x,y,radius,0,2*Math.PI);context.lineWidth=3;radius-=2;context.strokeStyle='lightblue';context.stroke()},50)}function _checkbox(width,height){let canvas=_cl('canvas');canvas.width=width;canvas.height=height;let context=canvas.getContext('2d');let radius=width/2;context.beginPath();context.arc(width/2,width/2,radius,0,2*Math.PI);context.closePath();context.fillStyle='lightblue';context.fill();canvas.addEventListener('click',function(){});return canvas}function _howMuch(el){let style=window.getComputedStyle(el);let width=style.getPropertyValue('width');return parseInt(width)+13}let Controller=(function(){let routes=[];let route1={route:prefix+'init',url:'',dependencies:['main--init'],used:0};let route2={route:prefix+'created',url:'',dependencies:[],used:0};let route3={route:prefix+'loggin',url:'',dependencies:[],used:0};routes.push(route1);routes.push(route2);routes.push(route3);let Router=function(route){switch(route){case 'init':View.init();break;case 'created':container.remove();document.getElementById(prefix+'background').remove();break;case 'loggin':container.remove();document.getElementById(prefix+'background').remove();_l('register').innerHTML=Database.User.user().user;_l('register').classList.add(prefix+'account-name');break;default:break}};return{Router:Router,routes:routes}})();App.Add(Controller)})();let signup=(function(){let prefix='signup--';let container;let header;let body;let step=8;let inputs=[{holder:'name',type:'text'},{holder:'surname',type:'text'},{holder:'password',type:'text'},{holder:'re-password',type:'text'},{holder:'phone',type:'text'},{holder:'email',type:'text'}];let View={init:function(){document.getElementsByClassName('container--footer')[0].style.display='none';_createBackground();setHeader();setProfile();setBody();createElements()},configure:function(){}};function _createBackground(){container=_cl('div');container.classList.add(prefix+'container');container.id=prefix+'container';let CN=_l('container');CN.appendChild(container)}function setHeader(){let prefix='profile--';header=_cl('div');header.classList.add(prefix+'header');header.style.height=60;container.append(header)}function setProfile(){let prefix='profile--';let profile=_cl('div');profile.classList.add(prefix+'identity');let image=new Image();image.src=getLink('me');image.classList.add(prefix+'profile-image');let name=_cl('div');name.classList.add(prefix+'name');name.innerHTML='Abohamze Somali';let sms=new Image();sms.classList.add(prefix+'sms');sms.src=getLink('sms');sms.addEventListener('click',()=>{});let contact=_cl('div');contact.classList.add(prefix+'contact');contact.append(sms);if(config.dir){contact.style.float='left';profile.style.float='right';name.style.direction="rtl";profile.append(name);profile.append(image);name.classList.add(prefix+'name-right')}else{profile.style.float='left';contact.style.float='right';name.style.direction="ltr";profile.append(image);profile.append(name)}header.append(profile);header.append(contact)}function setBody(){body=_cl('div');body.classList.add(prefix+'body');body.style.height=_calculateHeight();container.appendChild(body)}function _createElements(){let name=_cl('input');name.classList.add(prefix+'name',prefix+'inputs');name.placeholder='your name';let surname=_cl('input');surname.classList.add(prefix+'surname',prefix+'inputs');surname.placeholder='your surname';let phone=_cl('input');phone.classList.add(prefix+'phone',prefix+'inputs');phone.placeholder='phone number';let password=_cl('input');password.classList.add(prefix+'password',prefix+'inputs');password.placeholder='password';password.type='password';let repassword=_cl('input');repassword.classList.add(prefix+'repassword',prefix+'inputs');repassword.placeholder="retype password";repassword.type="password";let email=_cl('input');email.classList.add(prefix+'email',prefix+'inputs');email.value="amail.moc@gmail.com";body.appendChild(name);body.appendChild(surname);body.appendChild(password);body.appendChild(repassword);body.appendChild(phone);body.appendChild(email);body.append(createInputs("testing"))}function createElements(){inputs.forEach((elem)=>{let box=createInputs(elem);body.append(box);let re=/password/;if(re.exec(elem.holder)){console.log(elem.holder);let input=box.firstChild;console.log(input);new MaskedPassword(input,'\u25CF')}});let actionBox=_cl('div');actionBox.classList.add("user--action");actionBox.innerHTML='send';actionBox.addEventListener('click',_signup);let passwords=document.getElementsByClassName('mask--wrapper');Array.from(passwords).forEach(elem=>{elem.addEventListener('click',_=>{let width=_howMuch(elem.nextSibling);__slideLeft(elem.nextSibling,10,width+10,width+10)})});body.append(actionBox)}function _signup(){let re=/password/;let obj={'action':'signup'};inputs.forEach(elem=>{if(re.exec(elem.holder)){obj[elem.holder]=document.getElementById(elem.holder).previousSibling.value}else{obj[elem.holder]=document.getElementById(elem.holder).value}});ws.send(JSON.stringify(obj))}function _calculateHeight(){let total=config.height;return(total-(120+50+20+20)+32)}function createInputs(elem){let prefix="user--";let box=_cl('div');let label=_cl('div');label.innerHTML=elem.holder;label.classList.add(prefix+'label-user');let input=_cl("input");input.type=elem.type;input.id=elem.holder;input.classList.add(prefix+'login-user');box.append(input);box.append(label);box.classList.add(prefix+'login-username');input.addEventListener('focus',_=>{let width=_howMuch(label);__slideLeft(label,10,width+10,width+10)});input.addEventListener('blur',function(){this.style.border='none';this.style.backgroundColor='#ffff0082'});input.classList.add('signup--inputs');return box}let __slideRight=function(container,time,remains,left){setTimeout(function(){if(remains==left){container.style.left=left;step=8;return}if((left-remains)<step){step=(left-remains)}container.style.left=remains;__slideRight(container,time,remains+step,left)},time)};let _slideLeft=function(container,time,remains,left){setTimeout(function(){if(remains==0){container.style.left=0;step=8;return}if(remains<step){step=remains}container.style.left=remains;_slideLeft(container,time,remains-step,left)},time)};let __slideLeft=function(container,time,remains,left){setTimeout(function(){if(remains==0){step=8;return}if(remains<step){step=remains}if(config.dir){container.style.right=remains-left}else{container.style.left=remains-left}__slideLeft(container,time,remains-step,left)},time)};function _howMuch(el){let style=window.getComputedStyle(el);let width=style.getPropertyValue('width');return parseInt(width)+13}function notifyme(){alert('created')}let Controller=(function(){R.registerEvent('signup-created');R.addEventListener('signup-created',function(){alert('done')});let routes=[];let route1={route:prefix+'init',url:'',dependencies:['main--init'],used:0};let route2={route:prefix+'error',url:'',dependencies:['main--init'],used:0};routes.push(route1);routes.push(route2);let Router=function(route){switch(route){case 'init':View.init();break;case 'error':console.log(Database.Signup.get());break;default:break}};return{Router:Router,routes:routes}})();App.Add(Controller)})();window.onload=App.start;
